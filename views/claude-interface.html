<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Claude - {{USERNAME}}</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
            background: linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            width: 100%;
            max-width: 800px;
            background: rgba(30, 30, 45, 0.95);
            border-radius: 24px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.6);
            overflow: hidden;
            animation: slideUp 0.5s ease;
            border: 1px solid rgba(102, 126, 234, 0.2);
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
            border-bottom: 1px solid rgba(102, 126, 234, 0.3);
        }

        .header h1 {
            font-size: 32px;
            font-weight: 600;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
        }

        .user-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: rgba(255, 255, 255, 0.15);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            margin-top: 10px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .content {
            padding: 30px;
        }

        .input-wrapper {
            position: relative;
            margin-bottom: 20px;
        }

        .input-section textarea {
            width: 100%;
            padding: 16px 20px;
            border: 2px solid rgba(102, 126, 234, 0.3);
            border-radius: 16px;
            font-size: 16px;
            font-family: inherit;
            resize: none;
            transition: all 0.3s ease;
            background: rgba(20, 20, 35, 0.6);
            color: #e2e8f0;
            min-height: 120px;
        }

        .input-section textarea::placeholder {
            color: #718096;
        }

        .input-section textarea:focus {
            outline: none;
            border-color: #667eea;
            background: rgba(20, 20, 35, 0.8);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .trigger-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 16px 32px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            border-radius: 12px;
            width: 100%;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .trigger-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.5);
        }

        .trigger-btn:active {
            transform: translateY(0);
        }

        .trigger-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .response-section {
            background: rgba(20, 20, 35, 0.5);
            border-radius: 16px;
            padding: 24px;
            margin: 24px 0;
            display: none;
            animation: fadeIn 0.4s ease;
            border-left: 4px solid #667eea;
            border: 1px solid rgba(102, 126, 234, 0.3);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .response-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .response-label {
            font-weight: 600;
            color: #667eea;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .copy-btn {
            background: rgba(102, 126, 234, 0.1);
            border: 1px solid rgba(102, 126, 234, 0.3);
            color: #a5b4fc;
            padding: 6px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .copy-btn:hover {
            background: rgba(102, 126, 234, 0.2);
            border-color: #667eea;
            color: #e2e8f0;
        }

        .response-text {
            font-size: 16px;
            line-height: 1.7;
            color: #e2e8f0;
            margin-bottom: 16px;
            white-space: pre-wrap;
        }

        .audio-controls {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .audio-btn {
            background: rgba(102, 126, 234, 0.1);
            color: #a5b4fc;
            border: 2px solid rgba(102, 126, 234, 0.4);
            padding: 10px 20px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            border-radius: 10px;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .audio-btn:hover {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .voice-section {
            background: rgba(20, 20, 35, 0.5);
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            border: 1px solid rgba(102, 126, 234, 0.3);
        }

        .voice-select-wrapper {
            margin-bottom: 16px;
        }

        .voice-select-wrapper label {
            display: block;
            font-weight: 500;
            margin-bottom: 8px;
            color: #a5b4fc;
            font-size: 14px;
        }

        #voiceSelect {
            width: 100%;
            padding: 10px 16px;
            border: 2px solid rgba(102, 126, 234, 0.3);
            border-radius: 10px;
            font-size: 14px;
            background: rgba(20, 20, 35, 0.6);
            color: #e2e8f0;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        #voiceSelect:focus {
            outline: none;
            border-color: #667eea;
            background: rgba(20, 20, 35, 0.8);
        }

        #voiceSelect option {
            background: #1a1a2e;
            color: #e2e8f0;
        }

        .voice-trigger-btn {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            border: none;
            padding: 14px 28px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            border-radius: 10px;
            width: 100%;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(245, 87, 108, 0.3);
        }

        .voice-trigger-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(245, 87, 108, 0.4);
        }

        .voice-hint {
            text-align: center;
            font-size: 12px;
            color: #718096;
            margin-top: 8px;
        }

        .back-link {
            text-align: center;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid rgba(102, 126, 234, 0.2);
        }

        .back-link a {
            color: #a5b4fc;
            text-decoration: none;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .back-link a:hover {
            color: #667eea;
        }

        #voiceStatus {
            margin-top: 12px;
            padding: 12px;
            border-radius: 8px;
            text-align: center;
            font-weight: 500;
            display: none;
        }

        /* Mobile responsive */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            .header h1 {
                font-size: 24px;
            }
            .content {
                padding: 20px;
            }
            .audio-controls {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🤖 Claude AI</h1>
            <div class="user-badge">
                👤 {{USERNAME}}
            </div>
        </div>

        <div class="content">
            <div class="input-wrapper">
                <div class="input-section">
                    <textarea id="claudePrompt" placeholder="Ask Claude anything..." maxlength="2000"></textarea>
                    <div id="voiceStatus"></div>
                </div>
            </div>

            <button id="triggerBtn" class="trigger-btn" onclick="triggerClaude()">✨ Ask Claude</button>

            <div id="voiceSection" class="voice-section" style="display: none;">
                <div class="voice-select-wrapper">
                    <label for="voiceSelect">AI Voice</label>
                    <select id="voiceSelect">
                        <option value="">Loading AI voices...</option>
                    </select>
                </div>

                <button id="oneTimeTrigger" class="voice-trigger-btn" onclick="startOneTimeVoiceFlow()">
                    🎤 Voice Ask
                </button>
                <p class="voice-hint">Tap once → Speak → Get instant response</p>
            </div>

            <div id="responseSection" class="response-section">
                <div class="response-header">
                    <span class="response-label">Claude's Response</span>
                    <button class="copy-btn" onclick="copyResponse()">
                        📋 Copy
                    </button>
                </div>
                <div id="responseText" class="response-text"></div>
                <div class="audio-controls">
                    <button class="audio-btn" onclick="speakResponse()">▶️ Play Audio</button>
                    <button class="audio-btn" onclick="stopSpeaking()">⏹️ Stop</button>
                </div>
            </div>

            <div class="back-link">
                <a href="/auth">← Back to Dashboard</a>
            </div>
        </div>
    </div>

    <script>
        let currentUtterance = null;
        let isPaused = false;
        let recognition = null;
        let isListening = false;
        let isGeneratingTTS = false; // Track TTS generation state

        function setPreset(text) {
            document.getElementById('claudePrompt').value = text;
        }

        function copyResponse() {
            const responseText = document.getElementById('responseText').textContent;
            if (!responseText) return;

            navigator.clipboard.writeText(responseText).then(() => {
                const copyBtn = document.querySelector('.copy-btn');
                const originalText = copyBtn.innerHTML;
                copyBtn.innerHTML = '✅ Copied!';
                copyBtn.style.borderColor = '#48bb78';
                copyBtn.style.color = '#48bb78';

                setTimeout(() => {
                    copyBtn.innerHTML = originalText;
                    copyBtn.style.borderColor = '';
                    copyBtn.style.color = '';
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy:', err);
                alert('Failed to copy to clipboard');
            });
        }

        async function triggerClaude() {
            const prompt = document.getElementById('claudePrompt').value.trim();
            const triggerBtn = document.getElementById('triggerBtn');
            const responseSection = document.getElementById('responseSection');
            const responseText = document.getElementById('responseText');

            if (!prompt) {
                alert('Please enter a question for Claude');
                return;
            }

            // Always auto-play voice response
            userTriggeredAutoSpeak = true;

            // Update UI
            triggerBtn.disabled = true;
            triggerBtn.textContent = '🔄 Asking Claude...';
            responseSection.style.display = 'none';

            try {
                const response = await fetch('/auth/api/claude', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ prompt: prompt })
                });

                const data = await response.json();

                if (data.success) {
                    // Clear TTS cache for new response
                    cachedAudioUrl = null;
                    cachedAudioText = null;
                    cachedAudioVoice = null;
                    console.log('🎵 Cleared TTS cache for new Claude response');

                    // ALWAYS show text immediately (matches Twitch chat timing)
                    console.log('🎵 Showing Claude response immediately on UI');
                    responseText.textContent = data.response;
                    responseSection.style.display = 'block';

                    // For voice triggers, also start TTS in background
                    if (userTriggeredAutoSpeak) {
                        console.log('🎵 Voice triggered - starting TTS in background...');
                        userTriggeredAutoSpeak = false; // Reset flag AFTER checking

                        // Give a small delay to ensure UI is ready
                        setTimeout(() => {
                            try {
                                // Start TTS generation/playback without waiting
                                speakResponse().catch(error => {
                                    console.error('🎵 Auto-speak failed:', error);
                                });
                                console.log('🎵 Auto-speak initiated');
                            } catch (error) {
                                console.error('🎵 Auto-speak failed:', error);
                            }
                        }, 100);
                    }
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Failed to communicate with Claude. Please try again.');
            } finally {
                triggerBtn.disabled = false;
                triggerBtn.textContent = '✨ Ask Claude';
            }
        }

        async function speakResponse() {
            console.log('🎵 Play button clicked');

            // Prevent multiple simultaneous TTS requests
            if (isGeneratingTTS) {
                console.log('🎵 TTS already generating, ignoring click');
                return;
            }

            // Get text from displayed text (always available immediately)
            const text = document.getElementById('responseText').textContent;
            const volume = 0.8; // Default volume
            const selectedVoiceId = document.getElementById('voiceSelect').value;

            if (!text) {
                console.log('🎵 No text to speak');
                return;
            }

            // Stop any existing speech first
            speechSynthesis.cancel();
            if (currentAudio) {
                currentAudio.pause();
                currentAudio = null;
            }

            // Check if we can reuse cached audio
            if (cachedAudioUrl && cachedAudioText === text && cachedAudioVoice === selectedVoiceId) {
                console.log('🎵 Using cached audio URL:', cachedAudioUrl);
                playAudioFromUrl(cachedAudioUrl, volume);
                return;
            }

            // Need to generate new TTS
            console.log('🎵 Generating new TTS for text:', text.substring(0, 50) + '...');
            isGeneratingTTS = true;
            updatePlayStopButtons(true);

            try {
                // Use AI voice if available, fallback to system voice
                if (selectedVoiceId && selectedVoiceId !== 'system') {
                    console.log('🎵 Using AI voice:', selectedVoiceId);
                    await speakWithAI(text, selectedVoiceId, volume);
                } else {
                    console.log('🎵 Using system voice');
                    speakWithSystemVoice(text, volume);
                    // Cache system voice (though no URL to cache)
                    cachedAudioText = text;
                    cachedAudioVoice = selectedVoiceId;
                    cachedAudioUrl = null; // System voice has no URL
                }
            } catch (error) {
                console.error('🎵 TTS generation failed:', error);
                updatePlayStopButtons(false);
            } finally {
                isGeneratingTTS = false;
            }
        }

        let currentAudio = null;
        let userTriggeredAutoSpeak = false; // Track if user expects auto-speak
        let cachedAudioUrl = null; // Cache the TTS audio URL
        let cachedAudioText = null; // Cache the text that was used for TTS
        let cachedAudioVoice = null; // Cache the voice that was used

        function updatePlayStopButtons(isPlaying) {
            const playBtn = document.querySelector('.audio-btn[onclick="speakResponse()"]');
            const stopBtn = document.querySelector('.audio-btn[onclick="stopSpeaking()"]');

            if (isPlaying || isGeneratingTTS) {
                if (playBtn) {
                    playBtn.disabled = true;
                    playBtn.textContent = isGeneratingTTS ? '⏳ Generating...' : '🔊 Playing...';
                    playBtn.style.opacity = '0.6';
                }
                if (stopBtn) {
                    stopBtn.disabled = false;
                    stopBtn.style.opacity = '1';
                }
            } else {
                if (playBtn) {
                    playBtn.disabled = false;
                    playBtn.textContent = '▶️ Play';
                    playBtn.style.opacity = '1';
                }
                if (stopBtn) {
                    stopBtn.disabled = false;
                    stopBtn.style.opacity = '1';
                }
            }
        }

        function playAudioFromUrl(audioUrl, volume) {
            console.log('🎵 Playing cached audio from URL');

            // Use prepped audio if available (for mobile), otherwise create new
            if (window.preppedAudio) {
                currentAudio = window.preppedAudio;
                currentAudio.src = audioUrl;
                window.preppedAudio = null; // Clear it
            } else {
                currentAudio = new Audio(audioUrl);
            }

            currentAudio.volume = parseFloat(volume);

            currentAudio.onended = () => {
                console.log('🎵 Cached audio playback ended');
                currentAudio = null;
                updatePlayStopButtons(false);
            };

            currentAudio.onerror = (error) => {
                console.error('🎵 Cached audio playback error:', error);
                currentAudio = null;
                updatePlayStopButtons(false);
            };

            updatePlayStopButtons(true);
            currentAudio.play().catch(error => {
                console.error('🎵 Cached audio play failed:', error);
                updatePlayStopButtons(false);
            });
        }

        async function speakWithAI(text, voiceId, volume) {
            // Generate speech using premium AI voices
            const response = await fetch('/auth/api/tts', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    text: text,
                    voice_id: voiceId,
                    volume: volume
                })
            });

            if (!response.ok) {
                throw new Error('TTS API failed');
            }

            const responseData = await response.json();

            if (responseData.success && responseData.audioUrl) {
                // We got a direct URL from TTS Monster
                console.log('Using TTS Monster direct URL:', responseData.audioUrl);

                // Cache the audio for future use
                cachedAudioUrl = responseData.audioUrl;
                cachedAudioText = text;
                cachedAudioVoice = voiceId;
                console.log('🎵 Cached TTS audio for future plays');

                // Use prepped audio if available (for mobile), otherwise create new
                if (window.preppedAudio) {
                    currentAudio = window.preppedAudio;
                    currentAudio.src = responseData.audioUrl;
                    window.preppedAudio = null; // Clear it
                    console.log('Using prepped audio for mobile compatibility');
                } else {
                    currentAudio = new Audio(responseData.audioUrl);
                }

                currentAudio.volume = parseFloat(volume);

                return new Promise((resolve, reject) => {
                    currentAudio.onended = () => {
                        console.log('🎵 Audio playback ended');
                        currentAudio = null; // Clear audio reference
                        updatePlayStopButtons(false);
                        resolve();
                    };

                    currentAudio.onerror = (error) => {
                        console.error('🎵 Audio playback error:', error);
                        currentAudio = null; // Clear audio reference
                        updatePlayStopButtons(false);
                        reject(error);
                    };

                    currentAudio.oncanplay = () => {
                        console.log('🎵 Audio ready to play');
                        isGeneratingTTS = false; // Generation complete
                        updatePlayStopButtons(true);
                    };

                    // Text is already shown immediately when Claude responds

                    console.log('🎵 Starting audio playback');
                    currentAudio.play().catch(error => {
                        console.error('🎵 Audio play failed:', error);
                        updatePlayStopButtons(false);
                        isGeneratingTTS = false;
                        reject(error);
                    });
                });
            } else if (responseData.fallback === 'browser') {
                // Use enhanced browser TTS with better settings
                console.log('Using enhanced system voice fallback');
                return speakWithEnhancedSystemVoice(text, responseData.voice_settings);
            } else {
                throw new Error('No audio service available');
            }
        }

        function speakWithEnhancedSystemVoice(text, voiceSettings) {
            return new Promise((resolve, reject) => {
                currentUtterance = new SpeechSynthesisUtterance(text);
                currentUtterance.volume = voiceSettings.volume || 0.8;
                currentUtterance.rate = voiceSettings.rate || 0.85;
                currentUtterance.pitch = voiceSettings.pitch || 1.0;

                // Find the best available system voice with quality prioritization
                const voices = speechSynthesis.getVoices();
                console.log('Available voices:', voices.map(v => v.name + ' (' + v.lang + ')'));

                // Priority list of high-quality voices
                const qualityVoices = [
                    // Google voices (highest quality)
                    'Google US English',
                    'Google UK English Female',
                    'Google UK English Male',
                    'Google Australian English',
                    'Google Canadian English',
                    // Microsoft Neural voices
                    'Microsoft Aria Online (Natural) - English (United States)',
                    'Microsoft Jenny Online (Natural) - English (United States)',
                    'Microsoft Guy Online (Natural) - English (United States)',
                    'Microsoft Zira - English (United States)',
                    'Microsoft Mark - English (United States)',
                    // macOS voices
                    'Samantha',
                    'Alex',
                    'Victoria',
                    'Karen',
                    'Moira',
                    'Tessa',
                    'Veena',
                    // iOS voices
                    'Nicky',
                    'Siri Female',
                    'Siri Male'
                ];

                // Find the best available voice
                let selectedVoice = null;
                for (const qualityVoiceName of qualityVoices) {
                    selectedVoice = voices.find(voice =>
                        voice.name.includes(qualityVoiceName) ||
                        voice.name === qualityVoiceName
                    );
                    if (selectedVoice) break;
                }

                // If no quality voice found, try any English voice
                if (!selectedVoice) {
                    selectedVoice = voices.find(voice =>
                        voice.lang.startsWith('en-') &&
                        !voice.name.includes('eSpeak')
                    );
                }

                if (selectedVoice) {
                    currentUtterance.voice = selectedVoice;
                    console.log('Using enhanced system voice:', selectedVoice.name, '(' + selectedVoice.lang + ')');
                }

                currentUtterance.onend = () => {
                    console.log('🎵 System voice playback ended');
                    isPaused = false;
                    currentUtterance = null; // Clear utterance reference
                    updatePlayStopButtons(false);
                    resolve();
                };

                currentUtterance.onerror = (error) => {
                    console.error('🎵 System voice error:', error);
                    currentUtterance = null; // Clear utterance reference
                    updatePlayStopButtons(false);
                    reject(error);
                };

                currentUtterance.onstart = () => {
                    console.log('🎵 System voice playback started');
                    isGeneratingTTS = false; // Generation complete, now playing
                    updatePlayStopButtons(true);
                };

                speechSynthesis.speak(currentUtterance);
                isPaused = false;
            });
        }

        function speakWithSystemVoice(text, volume) {
            const voiceSettings = {
                volume: parseFloat(volume),
                rate: 0.85,
                pitch: 1.0
            };
            speakWithEnhancedSystemVoice(text, voiceSettings);
        }

        function stopSpeaking() {
            console.log('🛑 Stopping all audio playback');

            // Cancel speech synthesis
            speechSynthesis.cancel();

            // Stop current audio
            if (currentAudio) {
                currentAudio.pause();
                currentAudio.currentTime = 0; // Reset to beginning
                currentAudio = null;
            }

            // Reset state
            isPaused = false;
            isGeneratingTTS = false;

            // Update button states
            updatePlayStopButtons(false);

            console.log('🛑 Audio stopped successfully');
        }

        function pauseSpeaking() {
            if (currentAudio && !currentAudio.paused) {
                currentAudio.pause();
                isPaused = true;
            } else if (speechSynthesis.speaking && !isPaused) {
                speechSynthesis.pause();
                isPaused = true;
            }
        }

        function resumeSpeaking() {
            if (currentAudio && currentAudio.paused) {
                currentAudio.play();
                isPaused = false;
            } else if (isPaused) {
                speechSynthesis.resume();
                isPaused = false;
            }
        }

        // Initialize speech recognition
        function initSpeechRecognition() {
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();

                // Minimal settings for maximum compatibility
                recognition.continuous = false;
                recognition.interimResults = false;
                recognition.lang = 'en-US';
                recognition.maxAlternatives = 1;

                recognition.onstart = function() {
                    isListening = true;
                    console.log('🎤 SPEECH: Recognition started successfully');
                    console.log('🎤 SPEECH: isListening =', isListening);

                    // Update visual indicators
                    const voiceStatus = document.getElementById('voiceStatus');
                    const oneTimeBtn = document.getElementById('oneTimeTrigger');

                    voiceStatus.style.display = 'block';
                    voiceStatus.style.backgroundColor = '#d4edda';
                    voiceStatus.style.color = '#155724';
                    voiceStatus.style.border = '1px solid #c3e6cb';
                    voiceStatus.textContent = '🎤 LISTENING - Speak now!';

                    oneTimeBtn.style.backgroundColor = '#dc3545';
                    oneTimeBtn.textContent = '🔴 Recording...';

                    // Only play beep on mobile - desktop has audio conflicts
                    const isMobile = isMobileDevice();
                    if (isMobile) {
                        try {
                            const startBeep = new AudioContext();
                            const oscillator = startBeep.createOscillator();
                            const gainNode = startBeep.createGain();

                            oscillator.connect(gainNode);
                            gainNode.connect(startBeep.destination);

                            oscillator.frequency.setValueAtTime(800, startBeep.currentTime); // High pitch
                            gainNode.gain.setValueAtTime(0.1, startBeep.currentTime);

                            oscillator.start();
                            oscillator.stop(startBeep.currentTime + 0.1); // 100ms beep
                        } catch (error) {
                            console.log('Could not play start beep:', error);
                        }
                    } else {
                        console.log('🎤 Desktop: Beep disabled to prevent audio conflicts');
                    }
                };

                recognition.onresult = function(event) {
                    console.log('🎤 SPEECH: onresult event fired, resultIndex:', event.resultIndex, 'results.length:', event.results.length);

                    let transcript = '';
                    let isFinal = false;

                    for (let i = event.resultIndex; i < event.results.length; i++) {
                        const result = event.results[i];

                        // Check all alternatives and pick the one with highest confidence
                        let bestTranscript = result[0].transcript;
                        let bestConfidence = result[0].confidence;

                        for (let j = 0; j < result.length && j < 3; j++) {
                            const alternative = result[j];
                            console.log('🎤 SPEECH: Alternative', j, '- Text:', '"' + alternative.transcript + '"', 'confidence:', alternative.confidence);

                            if (alternative.confidence > bestConfidence) {
                                bestTranscript = alternative.transcript;
                                bestConfidence = alternative.confidence;
                            }
                        }

                        transcript += bestTranscript;
                        console.log('🎤 SPEECH: Best result for', i, '- Text:', '"' + bestTranscript + '"', 'confidence:', bestConfidence, 'isFinal:', result.isFinal);

                        if (result.isFinal) {
                            isFinal = true;
                        }
                    }

                    console.log('🎤 SPEECH: Combined transcript:', '"' + transcript + '"', 'isFinal:', isFinal);

                    // Update textarea with current transcript
                    document.getElementById('claudePrompt').value = transcript.trim();

                    if (isFinal) {
                        console.log('🎤 SPEECH: Final result detected, stopping recognition and triggering Claude');
                        // Stop listening immediately to free up microphone
                        stopListening();
                        // Automatically trigger Claude after speech completes
                        setTimeout(() => {
                            if (transcript.trim().length > 0) {
                                console.log('🎤 SPEECH: Triggering Claude with final transcript:', '"' + transcript.trim() + '"');
                                triggerClaude();
                            } else {
                                console.log('🎤 SPEECH: Empty transcript, not triggering Claude');
                            }
                        }, 300);
                    }
                };

                recognition.onerror = function(event) {
                    console.error('🎤 SPEECH ERROR: Type:', event.error, 'isListening:', isListening);
                    console.error('🎤 SPEECH ERROR: Full event:', event);

                    const isMobile = isMobileDevice();

                    // Handle specific errors
                    if (event.error === 'not-allowed') {
                        console.error('🎤 SPEECH ERROR: Microphone access denied');
                        alert('Microphone access denied. Please enable microphone permissions in your browser settings.');
                        stopListening();
                    } else if (event.error === 'no-speech') {
                        console.log('🎤 SPEECH ERROR: No speech detected - ending session');
                        if (!isMobile) {
                            alert('No speech detected. Please speak closer to your microphone.');
                        }
                        stopListening();
                    } else if (event.error === 'audio-capture') {
                        console.log('🎤 SPEECH ERROR: Audio capture error (likely microphone conflict)');
                        if (!isMobile) {
                            alert('Microphone error. Please check that your microphone is connected and not being used by another application.');
                        }
                        stopListening();
                    } else if (event.error === 'aborted') {
                        console.log('🎤 SPEECH ERROR: Speech recognition aborted - normal operation');
                        // Don't show error for intentional aborts
                    } else if (event.error === 'network') {
                        console.log('🎤 SPEECH ERROR: Network error');
                        alert('Network error during speech recognition. Please check your internet connection.');
                        stopListening();
                    } else {
                        console.log('🎤 SPEECH ERROR: Unknown error:', event.error);
                        if (!isMobile) {
                            alert('Speech recognition error: ' + event.error);
                        }
                        stopListening();
                    }
                };

                recognition.onend = function() {
                    console.log('🎤 SPEECH: onend event fired, isListening:', isListening);
                    stopListening();
                };

                return true;
            }
            return false;
        }

        function stopListening() {
            console.log('🎤 SPEECH: stopListening() called, current isListening:', isListening);
            isListening = false;

            // Reset button and visual indicators
            const oneTimeBtn = document.getElementById('oneTimeTrigger');
            const voiceStatus = document.getElementById('voiceStatus');

            oneTimeBtn.disabled = false;
            oneTimeBtn.textContent = '🎤 Voice Ask';
            oneTimeBtn.style.backgroundColor = '#dc3545'; // Reset to original color

            voiceStatus.style.display = 'none';

            if (recognition) {
                try {
                    console.log('🎤 SPEECH: Calling recognition.stop() and abort()');
                    recognition.stop();
                    recognition.abort(); // Force stop to prevent conflicts
                    console.log('🎤 SPEECH: Recognition stopped successfully');
                } catch (error) {
                    console.log('🎤 SPEECH: Recognition stop error (safely ignored):', error);
                }
            } else {
                console.log('🎤 SPEECH: No recognition object to stop');
            }
        }

        // Voice recording using MediaRecorder (works on all browsers)
        let mediaRecorder = null;
        let audioChunks = [];

        async function startOneTimeVoiceFlow() {
            // Clear any existing input
            document.getElementById('claudePrompt').value = '';

            // Update button
            const oneTimeBtn = document.getElementById('oneTimeTrigger');
            const voiceStatus = document.getElementById('voiceStatus');
            oneTimeBtn.disabled = true;
            oneTimeBtn.textContent = '🎤 Starting...';

            // Mark that user wants auto-speak
            userTriggeredAutoSpeak = true;

            try {
                // Request microphone access
                console.log('🎤 WHISPER: Requesting microphone access...');
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                console.log('🎤 WHISPER: Microphone access granted');

                // Reset audio chunks
                audioChunks = [];

                // Create MediaRecorder
                mediaRecorder = new MediaRecorder(stream);

                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        audioChunks.push(event.data);
                        console.log('🎤 WHISPER: Audio chunk received, size:', event.data.size);
                    }
                };

                mediaRecorder.onstop = async () => {
                    console.log('🎤 WHISPER: Recording stopped, processing audio...');

                    // Stop all tracks
                    stream.getTracks().forEach(track => track.stop());

                    // Create audio blob
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    console.log('🎤 WHISPER: Audio blob created, size:', audioBlob.size);

                    if (audioBlob.size === 0) {
                        console.log('🎤 WHISPER: Empty audio, aborting');
                        voiceStatus.style.display = 'none';
                        oneTimeBtn.disabled = false;
                        oneTimeBtn.textContent = '🎤 Voice Ask';
                        alert('No audio recorded. Please try again.');
                        return;
                    }

                    // Show processing status
                    voiceStatus.style.display = 'block';
                    voiceStatus.style.backgroundColor = '#fff3cd';
                    voiceStatus.style.color = '#856404';
                    voiceStatus.style.border = '1px solid #ffeaa7';
                    voiceStatus.textContent = '⏳ Processing speech...';

                    // Convert to base64
                    const reader = new FileReader();
                    reader.readAsDataURL(audioBlob);
                    reader.onloadend = async () => {
                        const base64Audio = reader.result.split(',')[1];
                        console.log('🎤 WHISPER: Base64 encoded, length:', base64Audio.length);

                        try {
                            // Send to Whisper API
                            console.log('🎤 WHISPER: Sending to server...');
                            const response = await fetch('/auth/api/whisper', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ audio: base64Audio })
                            });

                            const data = await response.json();

                            if (data.success && data.text) {
                                console.log('🎤 WHISPER: Transcription:', data.text);
                                document.getElementById('claudePrompt').value = data.text;
                                voiceStatus.style.display = 'none';

                                // Auto-trigger Claude
                                setTimeout(() => triggerClaude(), 300);
                            } else {
                                throw new Error(data.error || 'Transcription failed');
                            }
                        } catch (error) {
                            console.error('🎤 WHISPER: Error:', error);
                            voiceStatus.style.display = 'none';
                            alert('Speech recognition failed: ' + error.message);
                        } finally {
                            oneTimeBtn.disabled = false;
                            oneTimeBtn.textContent = '🎤 Voice Ask';
                        }
                    };
                };

                // Start recording
                mediaRecorder.start();
                console.log('🎤 WHISPER: Recording started');

                oneTimeBtn.style.backgroundColor = '#dc3545';
                oneTimeBtn.textContent = '🔴 Recording...';
                voiceStatus.style.display = 'block';
                voiceStatus.style.backgroundColor = '#d4edda';
                voiceStatus.style.color = '#155724';
                voiceStatus.style.border = '1px solid #c3e6cb';
                voiceStatus.textContent = '🎤 RECORDING - Speak now!';

                // Play start beep
                try {
                    const audioContext = new AudioContext();
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();

                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);

                    oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
                    gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);

                    oscillator.start();
                    oscillator.stop(audioContext.currentTime + 0.1);
                    console.log('🎤 WHISPER: Start beep played');
                } catch (error) {
                    console.log('🎤 WHISPER: Could not play start beep:', error);
                }

                // Stop after 10 seconds or when user clicks again
                setTimeout(() => {
                    if (mediaRecorder && mediaRecorder.state === 'recording') {
                        console.log('🎤 WHISPER: Auto-stopping after timeout');
                        mediaRecorder.stop();
                    }
                }, 10000);

            } catch (error) {
                console.error('🎤 WHISPER: Microphone error:', error);
                oneTimeBtn.disabled = false;
                oneTimeBtn.textContent = '🎤 Voice Ask';
                voiceStatus.style.display = 'none';
                alert('Microphone access denied or unavailable: ' + error.message);
            }
        }

        // Mobile detection function
        function isMobileDevice() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ||
                   ('ontouchstart' in window) ||
                   (window.innerWidth <= 768);
        }

        // Initialize speech recognition on page load
        document.addEventListener('DOMContentLoaded', function() {
            const isMobile = isMobileDevice();
            console.log('Device detection: Mobile =', isMobile);

            // Show voice features for all devices
            document.getElementById('voiceSection').style.display = 'block';
            document.getElementById('claudePrompt').placeholder = 'Type your question or use voice input...';

            // Initialize speech recognition
            initSpeechRecognition();
        });

        // Handle enter key in textarea
        document.getElementById('claudePrompt').addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                triggerClaude();
            }
        });

        // Load available voices
        function loadVoices() {
            const voiceSelect = document.getElementById('voiceSelect');
            voiceSelect.innerHTML = '';

            // Add TTS Monster AI voices
            const premiumVoices = [
                { id: 'circuit', name: '🤖 Circuit - Electronic', description: 'Electronic robotic voice - default' },
                { id: 'alpha', name: '🎭 Alpha - Male', description: 'Strong male voice' },
                { id: 'aurora', name: '🌟 Aurora - Female', description: 'Bright female voice' },
                { id: 'breeze', name: '🍃 Breeze - Female', description: 'Gentle female voice' },
                { id: 'commander', name: '⚔️ Commander - Male', description: 'Authoritative military voice' },
                { id: 'titan', name: '💪 Titan - Male', description: 'Deep powerful voice' },
                { id: 'vera', name: '💼 Vera - Female', description: 'Professional female voice' },
                { id: 'atlas', name: '🌍 Atlas - Male', description: 'Strong reliable voice' },
                { id: 'axel', name: '⚡ Axel - Male', description: 'Energetic male voice' },
                { id: 'blitz', name: '⚡ Blitz - Male', description: 'Fast-paced voice' },
                { id: 'breaker', name: '🔨 Breaker - Male', description: 'Tough rugged voice' },
                { id: 'chef', name: '👨‍🍳 Chef - Male', description: 'Friendly cooking voice' },
                { id: 'dash', name: '🏃 Dash - Male', description: 'Quick energetic voice' },
                { id: 'elder', name: '🧙 Elder - Male', description: 'Wise elderly voice' },
                { id: 'frost', name: '❄️ Frost - Male', description: 'Cool calm voice' },
                { id: 'hunter', name: '🏹 Hunter - Male', description: 'Focused tracking voice' },
                { id: 'kawaii', name: '🌸 Kawaii - Female', description: 'Cute anime-style voice' },
                { id: 'leader', name: '👑 Leader - Male', description: 'Commanding leadership voice' },
                { id: 'mentor', name: '👨‍🏫 Mentor - Male', description: 'Teaching guidance voice' },
                { id: 'reasonable', name: '🤝 Reasonable - Male', description: 'Calm logical voice' },
                { id: 'scout', name: '🔍 Scout - Male', description: 'Alert exploration voice' },
                { id: 'sentinel', name: '🛡️ Sentinel - Male', description: 'Protective guard voice' },
                { id: 'star', name: '⭐ Star - Male', description: 'Bright stellar voice' },
                { id: 'whisper', name: '🤫 Whisper - Male', description: 'Soft quiet voice' }
            ];

            premiumVoices.forEach((voice) => {
                const option = document.createElement('option');
                option.value = voice.id;
                option.textContent = voice.name;
                option.title = voice.description;

                // Set Circuit as default
                if (voice.id === 'circuit') {
                    option.selected = true;
                    option.textContent += ' ✨ (Default)';
                }

                voiceSelect.appendChild(option);
            });

            // Add separator
            const separator = document.createElement('option');
            separator.disabled = true;
            separator.textContent = '── System Voices ──';
            voiceSelect.appendChild(separator);

            // Add system voice option
            const systemOption = document.createElement('option');
            systemOption.value = 'system';
            systemOption.textContent = '🔧 Enhanced System Voice';
            systemOption.title = 'Best available browser voice with optimized settings';
            voiceSelect.appendChild(systemOption);

            console.log('Loaded TTS Monster AI voices + enhanced system voice');
        }

        // Load voices immediately and on change
        loadVoices();
        if (speechSynthesis.onvoiceschanged !== undefined) {
            speechSynthesis.onvoiceschanged = loadVoices;
        }
    </script>
</body>
</html>
